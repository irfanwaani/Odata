<!DOCTYPE html>
<html>
<head>
    <title>JSON API to Tableau</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
    <script>
        (function() {
 
            var myConnector = tableau.makeConnector();
 
            // Schema
            myConnector.getSchema = function(schemaCallback) {
                var cols = [
                    // { id: "number", dataType: tableau.dataTypeEnum.string },
                    { id: "short_description", dataType: tableau.dataTypeEnum.string },
                    { id: "category", dataType: tableau.dataTypeEnum.string },
                    { id: "state", dataType: tableau.dataTypeEnum.string },
                    { id: "priority", dataType: tableau.dataTypeEnum.string },
                ];
 
                schemaCallback([{
                    id: "apiData",
                    alias: "API JSON Data",
                    columns: cols
                }]);
            };
 
            // Data
            myConnector.getData = function(table, doneCallback) {
 
                fetch("https://dev284986.service-now.com/api/1467520/report_api")
                    .then(response => response.json())
                    .then(data => {
                        console.log(data)
                        let tableData = [];
 
                        // Assuming ServiceNow returns: { result: [...] }
                        data.result?.forEach(item => {
                            tableData.push({
                                number: item.number,
                                short_description: item.short_description,
                                category: item.category,
                                state: item.state,
                                priority: item.priority
                            });
                        });
 
                        table.appendRows(tableData);
                        doneCallback();
                    })
                    .catch(err => console.error(err));
            };
 
            tableau.registerConnector(myConnector);
 
            // Handle button click AFTER everything is registered
            document.addEventListener("DOMContentLoaded", function () {
                document.getElementById("getDataBtn").addEventListener("click", function () {
                    tableau.connectionName = "API JSON Data";
                    tableau.submit();
                });
            });
 
        })();
    </script>
</head>
<body>
    <button id="getDataBtn">Get Data</button>
</body>
</html>
